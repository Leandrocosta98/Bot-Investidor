<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Bot Investidor</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="data:,">

    <div class="chart-container" style="position: relative; height:40vh; width:80vw; margin: auto;">
    <canvas id="meuGrafico"></canvas>
    </div>

</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Ativos Monitorados</h1>
            <button class="btn-refresh" onclick="carregarDados()">üîÑ Atualizar</button>
        </header>

        <table>
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Pre√ßo Base</th>
                    <th>Alvo (-%)</th>
                    <th>A√ß√µes</th> </tr>
            </thead>
            <tbody id="corpo-tabela">
                </tbody>
        </table>
    </div>

    <script>
    // 1. Vari√°vel global para controlar a inst√¢ncia do gr√°fico
    let chartInstancia = null;

    // 2. Fun√ß√£o para carregar o gr√°fico (Global)
    async function carregarGrafico(ticker) {
        console.log("Chamando gr√°fico para:", ticker);
        try {
            const res = await fetch(`/api/historico/${ticker}`);
            const data = await res.json();
            
            if (!data.results || !data.results[0].historicalDataPrice) {
                alert("Dados hist√≥ricos n√£o encontrados para este ativo.");
                return;
            }

            const historico = data.results[0].historicalDataPrice;
            // Formata as datas para DD/MM
            const labels = historico.map(d => {
                const dataObj = new Date(d.date * 1000);
                return dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            });
            const precos = historico.map(d => d.close);

            const ctx = document.getElementById('meuGrafico').getContext('2d');
            
            // Destr√≥i o gr√°fico anterior antes de criar um novo
            if (chartInstancia) { 
                chartInstancia.destroy(); 
            }

            chartInstancia = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Pre√ßo de Fechamento - ${ticker}`,
                        data: precos,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        } catch (e) {
            console.error("Erro ao carregar gr√°fico:", e);
        }
    }

    // 3. Fun√ß√£o para carregar os dados da tabela
    async function carregarDados() {
        const tbody = document.getElementById('corpo-tabela');
        if (!tbody) return;

        try {
            const resposta = await fetch('/api/dados');
            const dados = await resposta.json();

            tbody.innerHTML = ""; // Limpa a tabela

            if (dados.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4'>Nenhum ativo monitorado.</td></tr>";
                return;
            }

            // Loop para criar as linhas da tabela
            dados.forEach(acao => {
                const precoAlvo = acao.precoBase * (1 - acao.limiteQueda);
                const row = `
                    <tr>
                        <td>
                            <strong 
                                onclick="carregarGrafico('${acao.ticker}')" 
                                style="cursor:pointer; color:#3498db; text-decoration:underline;"
                                title="Clique para ver o gr√°fico"
                            >
                                ${acao.ticker}
                            </strong>
                        </td>
                        <td>R$ ${acao.precoBase.toFixed(2)}</td>
                        <td>R$ ${precoAlvo.toFixed(2)} (${(acao.limiteQueda * 100).toFixed(0)}%)</td>
                        <td>
                            <button class="btn-delete" onclick="deletarAtivo(${acao.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Opcional: Carregar o gr√°fico da primeira a√ß√£o da lista automaticamente
            if (dados.length > 0) {
                carregarGrafico(dados[0].ticker);
            }

        } catch (error) {
            console.error("Erro ao carregar tabela:", error);
        }
    }

    // 4. Fun√ß√£o para deletar ativo (Precisa estar aqui tamb√©m)
    async function deletarAtivo(id) {
        if (confirm("Deseja remover este ativo?")) {
            const res = await fetch(`/api/deletar/${id}`, { method: 'DELETE' });
            if (res.ok) carregarDados();
        }
    }

    // Inicializa tudo quando a p√°gina carregar
    window.onload = carregarDados;
</script>
</body>
</html>